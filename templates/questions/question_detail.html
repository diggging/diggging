{% extends 'questions/base.html' %}
{% load static %}

{% block content %}
<div class="container_deatil">
    <div class="post_container">
        <!-- 제목영역 -->
        <div class="title_area">
            <h1>{{post.title}}</h1>
            <div class="post_user_info">
                {% if post.user.user_profile_image %}
                    <img src="{{post.user.user_profile_image.url}}">
                {% endif %}
                <span>{{post.user.username}}</span>
            </div>
        </div>
        <!-- 제목영역 끝 -->
        <div class="category_area">
            <span class="post_language">언어|{{post.language}}</span>
            <span class="folder_name">폴더|{{folder.folder_name}}</span>
            <span class="post_os">운영체제|{{post.os}}}</span>
            <div class="post_os">에러메시지|{{post.error_message}}</div>
        </div>
        <div class="desc_area">
            {{ post.desc|safe|escape }}
        </div>
        <div class="post_{{post.id}}">
            <div class="tag_area">{{post.tag}}</div>
            <button class="like_button post__like" onclick="onClickLikeScrap({{ post.id }}, 'like')">도움이되었어요 {{ post.helped_num }}</button>
            <span><a href="{% url 'posts:get_post' user_id=post.user.id post_id=post.id %}"><button class="post__scrap" onclick="onClickLikeScrap({{ post.id }}, 'scrap')">퍼가기 {{post.scrap_num}}</button></a></span>
        </div>
        {% if request.user.id == post.user.id %}
            <div class="edit_btn">
                <a href="{% url 'question:question_update' post.id %}">수정하기</button>
            </div>
            <div class="delete">
                <a href="{% url 'question:question_delete' post.id %}">삭제하기</a>
            </div>
        {% else %}
            <!-- 종권오빠가 쓴 퍼가기 버튼 -->
            <span><a href="{% url 'question:get_question' post.id %}">퍼가기</a></span>
            <!-- 포스트디테일에서 가져온 버튼들 -->
            <!-- <div class="post_{{post.id}}">
                <div class="tag_area">{{post.tag}}</div>
                <button class="like_button post__like" onclick="onClickLikeScrap({{ post.id }}, 'like')">도움이되었어요 {{ post.helped_num }}</button>
                <span><a href="{% url 'posts:get_post' user_id=post.user.id post_id=post.id %}"><button class="post__scrap" onclick="onClickLikeScrap({{ post.id }}, 'scrap')">퍼가기 {{post.scrap_num}}</button></a></span>
            </div> -->
        {% endif %}
        <!-- 댓글창열기버튼 -->
        <a href="javascript:doDisplay();">댓글</a>
        <!-- 댓글창 영역 -->
        <div id="comment_box">
            <div class='addComment'>
            {% for comment in comments %}
                <div class='comment_id_{{comment_id}}'>
                    <div class="comment_text">
                        {{comment.text}}
                    </div>
                    <div class="delete_btn">
                        <button onclick="onClickDelete({{id}}, {{comment_id}})">삭제</button>
                    </div>
                </div>
            {% endfor %}
            </div>
            <div>
                <input class="comment_input" type="text" placeholder="댓글달기"/>
                <button onclick="onClickComment({{ post.id }})">게시</button> 
                <!--comment 별로 id 준당-->
            </div>
        </div>
    </div>
    <!-- 답변 영역 -->
    <a href="{% url 'question:answer_create' post.id %}"><button>답변 남기기</button></a>
    <div class="answer_area">
        {% if post_answers %}
            {% for answer in post_answers %}
                <div class="answer_container">
                    <div class="answer_info_box">
                        <h3>{{answer.answer_user.user_nickname}}님의 답변</h3>
                        <h3>채택여부 : {{answer.selection}}</h3>
                    </div>
                    <div class="answer_desc_box">
                        {{answer.desc}}
                    </div>
                </div>
            {% endfor %}
        {% endif %}
    </div>
{% endblock %}



{% block script %}
<link rel="stylesheet" href="{% static 'css/questions/question_detail.css' %}">
<!-- 코멘트 댓글 -->
<script>
    const requestComment = new XMLHttpRequest();
    const onClickComment = (id) =>{
        const url = '/comments/add_question_comment/';
        requestComment.open('POST', url, true);
        requestComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        const text = document.querySelector(`.comment_input`).value;
        requestComment.send(JSON.stringify({id:id, text:text}));
    };
    const commentHandleResponse = () =>{
        if(requestComment.status < 400){
            const {id} = JSON.parse(requestComment.response);
            const {text} = JSON.parse(requestComment.response);
            const {comment_id} = JSON.parse(requestComment.response);
            const addComment = document.querySelector(`.addComment`);
            console.log(comment_id);
        addComment.innerHTML += `
            <div class='comment_id_${comment_id}'>
                <div class="comment_text">
                    ${text}
                </div>
                <div class="delete_btn">
                    <button onclick="onClickDelete(${id}, ${comment_id})">삭제</button>
                </div>
            </div>
        `
        const cmt_input = document.querySelector('.comment_input');
        cmt_input.value = null
        };
    };
    requestComment.onreadystatechange = () =>{
        if(requestComment.readyState  === XMLHttpRequest.DONE){
            commentHandleResponse();
        };      
    };
    const requestDelComment = new XMLHttpRequest();
    const onClickDelete = (id, comment_id) =>{
        const url ='/comments/delete_question_comment/';
        requestDelComment.open('POST',url,true);
        requestDelComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestDelComment.send(JSON.stringify({id:id, comment_id:comment_id}));
    };
    const commentdelHandleResponse = () =>{
        if(requestDelComment.status<400){
            const {id} = JSON.parse(requestDelComment.response);
            const {comment_id} = JSON.parse(requestDelComment.response);
            const element = document.querySelector(`.comment_id_${comment_id}`);
            element.remove();
        };
    };
    requestDelComment.onreadystatechange = () =>{
        if(requestDelComment.readyState  === XMLHttpRequest.DONE){
            commentdelHandleResponse();
        };      
    };
</script>
<!-- 코멘트 끝 -->
<script type="text/javascript">
    function doDisplay(){
    var commentBox = document.getElementById("comment_box");
    if(commentBox.style.display=='none') {
        commentBox.style.display = 'block';
    } else {
        commentBox.style.display = 'none';
    }
}
</script>


<!-- 도움되었어요 스크랩버튼 기능 -->
<script>
    const requestLike = new XMLHttpRequest();
    
    const onClickLikeScrap = (id, type) => { //함수정의 : 어떤 게시글인지 . 버튼 타입을 받아온다.
        const url = '/questions/count_like_scrap/'; //어느 url로 요청할 것인지.
        requestLike.open('POST', url, true); //post방식으로 이 url에 ajax방식으로 요청을보내는데, 
        requestLike.setRequestHeader( // requestheader로 이 요청을 보낸다. 자세한건 나중에
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestLike.send(JSON.stringify({id: id, type: type})); //요청할 때 필요한 정보들. ajax방식으로 할 땐 무.조.건 JSON방식으로 보내야함.
    };
    
    const likeHandleResponse = () => {  //응답 처리해주는 함수 ( 숫자 +1되는 처리)
        if (requestLike.status < 400) {
            const {id, type} = JSON.parse(requestLike.response);    // {'id': 1, 'type': 'like'}
            const element = document.querySelector(`.post_${id} .post__${type}`);
            const originHTML = element.innerHTML;
            const [buttonType, helped_num] = originHTML.split(' ');  // ['Like', '0']
            const count = Number(helped_num) + 1;
    
            element.innerHTML = `${buttonType} ${count}`;
        }
    };
    
    requestLike.onreadystatechange = () => {
        if (requestLike.readyState === XMLHttpRequest.DONE) {
            likeHandleResponse();
        }
    };
</script>    

{% endblock %}