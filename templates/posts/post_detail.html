{% extends 'base.html' %}
{% load static %}

{% block script %}
<link rel="stylesheet" href="{% static 'css/post_detail.css' %}">
<!-- axios cdn -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<!-- highlights.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.1/styles/vs2015.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script type="text/javascript">hljs.highlightAll();</script>
<script type="text/javascript">hljs.initHighlightingOnLoad();</script>
<script>
    //ë¹ˆ ì½”ë©˜íŠ¸ ê²Œì‹œ ì‹œ ì•ŒëŒì°½ ëœ¨ê²Œí•  div
    const test = document.querySelector('.addComment');
    const body = document.querySelector('body');
    const nullComment = (input) => {
            const newDiv = document.createElement('div');
            const newText = document.createTextNode('ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ì—¬!!');
            newDiv.appendChild(newText);
            //newDiv ì»¤ìŠ¤í…€
            newDiv.style.width = "100px";
            newDiv.style.height = "30px";

            newDiv.setAttribute('class', 'comment_alert');
            
            body.appendChild(newDiv);
            setTimeout(()=> {
                newDiv.remove()
            }, 2000)
        }
        //ëŒ“ê¸€ ìƒì„±
        const requestComment = new XMLHttpRequest();
        const commentInput = document.querySelector(`.comment_input`)
    
        const onClickComment = (id) => {
    
            if (!commentInput.value) {
                nullComment(commentInput)
                return false
            } else {
                const url = '/comments/comment/';
                requestComment.open('POST', url, true);
                requestComment.setRequestHeader(
                    'Content-Type',
                    'application/x-www-form-urlencoded'
                );
                const text = document.querySelector(`.comment_input`).value;
                requestComment.send(JSON.stringify({ id: id, text: text}));
                console.log(requestComment);
            }
        };
        
        const commentHandleResponse = () => {
            if (requestComment.status < 400) {
                const { id } = JSON.parse(requestComment.response);
                const { text } = JSON.parse(requestComment.response);
                const { comment_id } = JSON.parse(requestComment.response);
                const { comment_date } = JSON.parse(requestComment.response);
                const {user} = JSON.parse(requestComment.response);
                
                //ìœ ì € ë°ì´í„° ì§ë ¬í™”
                const userData = JSON.parse(user); 
                const userImg = userData[0].fields.user_profile_image;
                const userImgUrl = userImg.slice(2)
                const userName = userData[0].fields.user_nickname;
                const createDate = comment_date;
    
                const addComment = document.querySelector(`.addComment`);
                console.log(commentInput.value)
                // ì•„ë¬´ê²ƒë„ ì…ë ¥ì•ˆí–ˆì„ ë•Œ, ëŒ“ê¸€ ì•ˆë‹¬ë¦¼
    
                    addComment.innerHTML += `
                    <div class='comment_id_${comment_id}'>
                        <div class="comment_info">
                            <div class="comment_profile">
                                <img src="${userImgUrl}">
                                <span class="user_nicknamme">
                                ${userName}
                                </span>
                            </div>
                            <div class="comment_content">
                                <div class="comment_created">
                                    ${createDate}
                                </div>
                                <div class="comment_text">
                                    ${text}
                                </div>
                            </div>
                        </div>
                        <div class="delete_btn">
                            <button onclick="onClickDelete(${id}, ${comment_id})">ì‚­ì œ</button>
                        </div>
                    </div>
                `
                commentInput.value = null
            };
        };
    
        requestComment.onreadystatechange = () => {
            if (requestComment.readyState === XMLHttpRequest.DONE) {
                commentHandleResponse();
            };
        };

    const requestDelComment = new XMLHttpRequest();

    const onClickDelete = (id, comment_id) => {
        const url = '/comments/delete_comment/';
        requestDelComment.open('POST', url, true);
        requestDelComment.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );

        requestDelComment.send(JSON.stringify({ id: id, comment_id: comment_id }));
    };

    const commentdelHandleResponse = () => {
        if (requestDelComment.status < 400) {
            const { id } = JSON.parse(requestDelComment.response);
            const { comment_id } = JSON.parse(requestDelComment.response);
            console.log(comment_id)
            const element = document.querySelector(`.comment_id_${comment_id}`);
            element.remove();
        };
    };

    requestDelComment.onreadystatechange = () => {
        if (requestDelComment.readyState === XMLHttpRequest.DONE) {
            commentdelHandleResponse();
        };
    };
    function sendLinkFacebook() {
        var facebook_share_url = "https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}";
        window.open(facebook_share_url,
            'Share on Facebook',
            'scrollbars=no, width=500, height=500');
    }
    function sendLinkTwitter() {
        var twitter_share_text = "{{ post.title }}";
        var twitter_share_url = "{{ request.build_absolute_uri }}";
        window.open("https://twitter.com/share?text=" + twitter_share_text + "&url=" + twitter_share_url,
            'Share on Twitter',
            'scrollbars=no, width=500, height=500');
    }
    function sendLinkNaver() {
        var raw_url = "{{ request.build_absolute_uri }}";
        var raw_title = "{{ post.title }}"
        var naver_root_url = "http://share.naver.com/web/shareView.nhn?url="
        var naver_share_url = naver_root_url + encodeURI(raw_url) + "&title=" + encodeURI(raw_title);
        window.open(naver_share_url,
            'Share on Naver',
            'scrollbars=no, width=500, height=500');
    }
    $(".like").click(function () { // .like ë²„íŠ¼ì„ í´ë¦­ ê°ì§€
        var pk = $(this).attr('name')
        $.ajax({ // ajaxë¡œ ì„œë²„ì™€ í†µì‹  \
            type: "POST", // ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²• \
            url: "{% url 'posts:post_like' %}", // í†µì‹ í•  urlì„ ì§€ì • 
            data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ì‹œ ì˜µì…˜, pkë¥¼ ë„˜ê²¨ì•¼ ì–´ë–¤ postì¸ì§€ ì•Œ ìˆ˜ ìˆìŒ
            dataType: "json",
            success: function (response) { // ì„±ê³µ;
                $("#count-" + pk).html("ë„ì›€ì´ë˜ì—ˆì–´ìš”" + response.likes_count + "ê°œ"); // ì¢‹ì•„ìš” ê°œìˆ˜ ë³€ê²½
            },
            error: function (request, status, error) { // ì‹¤íŒ¨
                window.location.replace('/users/login')// ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ê¸°
            },
        });
    })

    $(".scrap").click(function () { // .scarp ë²„íŠ¼ì„ í´ë¦­ ê°ì§€
        var pk = $(this).attr('name')
        $.ajax({ // ajaxë¡œ ì„œë²„ì™€ í†µì‹  \
            type: "POST", // ë°ì´í„°ë¥¼ ì „ì†¡í•˜ëŠ” ë°©ë²• \
            url: "{% url 'posts:post_scrap' %}", // í†µì‹ í•  urlì„ ì§€ì • 
            data: { 'pk': pk, 'csrfmiddlewaretoken': '{{ csrf_token }}' }, // ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡ì‹œ ì˜µì…˜, pkë¥¼ ë„˜ê²¨ì•¼ ì–´ë–¤ postì¸ì§€ ì•Œ ìˆ˜ ìˆìŒ
            dataType: "json",
            success: function (response) { // ì„±ê³µ;
                $("#scarp-" + pk).html("í¼ê°€ê¸°" + response.scarps_count + "ê°œ"); // ì¢‹ì•„ìš” ê°œìˆ˜ ë³€ê²½
            },
            error: function (request, status, error) { // ì‹¤íŒ¨
                window.location.replace('/users/login')// ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë„˜ì–´ê°€ê¸°
            },
        });
    })


    // -------------------------------í¼ì˜¤ê¸° ëˆŒë €ì„ ë•Œ ì•Œë¦¼ì°½------------------     
const scrapPopup = document.querySelector('.scrap_popup')
const scrapButton = document.querySelector('.scrap');

scrapButton.addEventListener('click', () => {
    if (scrapPopup.style.opacity === "0") {
        scrapPopup.style.opacity = "1";
        scrapPopup.style.visibility = "visibile";
    } else {
        scrapPopup.style.opacity = "0"
    }
});

scrapPopup.addEventListener('click', () => {
    scrapPopup.style.opacity = "0";
    scrapPopup.style.visibility = "hidden";
})
</script>
{% endblock %}

{% block content %}

<div class="container_detail">
    {% if post.image %}
    <img src="{{ post.image.url }}" class="thumbnail_area">
    {% endif %}
    <div class="post_container">
        <div class="post_top">
            <div class="title_area">
                <h1>{{post.title}}</h1>
                <div class="post_user_info">
                    <img src="{{post.user.user_profile_image.url}}">
                    <span>{{post.user.user_nickname}}</span>
                </div>
            </div>
            {% if request.user.id == post.user.id %}
            <div class="auth_btn_area">
                <div class="edit_btn">
                    <a href="{% url 'posts:post_update' post.id %}">ìˆ˜ì •í•˜ê¸°</a>
                </div>
                <div class="delete_btn">
                    <a href="{% url 'posts:post_delete' post.id %}">ì‚­ì œí•˜ê¸°</a>
                </div>
            </div>
            {% endif %}
        </div>
        <div class="category_area">
            <span class="post_language">ì–¸ì–´|{{post.language}}</span>
            <span class="folder_name">í”„ë ˆì„ì›Œí¬|{{post.framework}}</span>
            <span class="post_os">ìš´ì˜ì²´ì œ|{{post.os}}</span>
            <div class="post_os">ì—ëŸ¬ë©”ì‹œì§€|{{post.error_message}}</div>
        </div>
        <div class="desc_area">
            {{ post.desc|safe|escape }}
        </div>
        {% if not request.user.id == post.user.id %}
        <div class="post_{{post.id}}">
            <div>
                <input type="button" class="like" name="{{ post.id }}" value="Like" style="margin-top: 7px">
                <button id="count-{{ post.id }}" style="font:bold 1em; margin-top: 3px">
                    ë„ì›€ì´ë˜ì—ˆì–´ìš”.{{ post.likes_user.all.count }}ê°œ</button>
            </div>
        </div>
        {% endif %}
        <div class="accordion_area">
            <button class="btn btn_toggle">ê³µìœ í•˜ê¸°</button>
            <div class="content_area">
                <span class="sociallink ml-1">
                    <a href="javascript:sendLinkFacebook()" title="í˜ì´ìŠ¤ë¶ìœ¼ë¡œ ê³µìœ ">
                        <img src="{% static 'image/facebook.png' %}" width=36 alt="Facebook">
                    </a>
                </span>
                <span class="sociallink ml-1">
                    <a href="javascript:sendLinkTwitter()" title="íŠ¸ìœ„í„°ë¡œ ê³µìœ ">
                        <img src="{% static 'image/twitter.png' %}" width=36 alt="Twitter">
                    </a>
                </span>
                <span class="sociallink ml-1">
                    <a href="javascript:sendLinkNaver()" title="ë„¤ì´ë²„ë¡œ ê³µìœ ">
                        <img src="{% static 'image/naver.png' %}" width=36 alt="Naver">
                    </a>
                </span>
                <span class="sociallink ml-1">
                    <a href="javascript:sendLinkKakao()" id="kakao-link-btn" title="ì¹´ì¹´ì˜¤í†¡ìœ¼ë¡œ ê³µìœ ">
                        <img src="{% static 'image/kakaotalk.png' %}" width=36 alt="Kakaotalk">
                        <!--ì´ê±°ëŠ” ë„ë©”ì¸ì´ì—†ì–´ì„œ ëª»í•˜ëŠ”ì¤‘ì„ë‹¹... ë°°í¬í•˜ë©´ ìˆ˜ì • í•  ì˜ˆì •.-->
                    </a>
                </span>
            </div>
            {% if not request.user.id == post.user.id %}
            <div>
                <input type="button" class="scrap" name="{{ post.id }}" value="scrap"
                    style="margin-top: 7px">
                <button id="scarp-{{ post.id }}" style="font:bold 1em; margin-top: 3px">
                    í¼ê°€ê¸°{{ post.scarps_user.all.count }}ê°œ</button>
            </div>
            <div class="scrap_popup" style="opacity: 0;" >
                <p>ì–¸ì–´ğŸ“ {{post.language}} í”„ë ˆì„ì›Œí¬ğŸ“ {{post.framework}}ìœ¼ë¡œ í¼ì™”ìŠµë‹ˆë‹¤.
                ë§ˆì´í˜ì´ì§€ì—ì„œ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            </div>
            {% endif %}
        </div>
        <div class="comment_area">
            <div class='addComment'>
                {% for comment in comments %}
                <div class='comment_id_{{comment.id}}'>
                    <div class="comment_info">
                        <div class="comment_profile">
                            <img src="{{comment.user.user_profile_image.url}}">
                            <span class="user_nicknamme">
                                {{comment.user.user_nickname}}
                            </span>
                        </div>
                        <div class="comment_content">
                            <div class="comment_created">
                                {{comment.created}}
                            </div>
                            <div class="comment_text">
                                {{comment.text}}
                            </div>
                        </div>
                    </div>
                    {% if request.user == comment.user %}
                    <div class="delete_btn">
                        <button onclick="onClickDelete({{post.id}},{{comment.id}})">ì‚­ì œ</button>
                        <!--comment ë³„ë¡œ id ì¤€ë‹¹-->
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div class="comment_input_area">
                <input class="comment_input" type="text" placeholder="ëŒ“ê¸€ë‹¬ê¸°" />
                <button onclick="onClickComment({{ post.id }})">ê²Œì‹œ</button>
                <!--comment ë³„ë¡œ id ì¤€ë‹¹-->
            </div>
        </div>
    </div>
</div>

<script>
//     // axios try
// const likeButton = document.querySelector('.like_button')
// likeButton.forEach(button => {
//     button.addEventListener('click', function(event){
//         const articleld = event.target.dataset.id
//         const likeCount = document.querySelector(`.like_count-${articledId}`)

//         $httpProvider.defaults.xsrfCookieName = 'csrftoken',
//         $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken'

//         axios.post(`/posts/${articled}/like/`)
//         .then(response) => {
//             likeCount.innerText = response.data.likeCount
//             if(request.data.liked){
//                 event.target.className = 'like_button'
//                 event.target.style.color = '#FFEF9C'
//             } else {
//                 event.target.className = 'like_button'
//                 event.target.style.color = '#FFF8CA'
//             }
//         }
//     })
// })

// ìŠ¤í¬ë©, ë„ì›€ë²„íŠ¼ axios ì‹¤ìŠµë”°ë¼í•˜ê¸°
// const onClickLikeScrap = async(id, type) => { 
//         const url = '/posts/count_like_scrap/';
//         const {data} = await axios.post(url, {   //axios.method(url {JSONì•ˆí•´ì¤˜ë„ë¨ ë„˜ê²¨ì¤„ ì¸ì}) {data}-? : axiosë‹¤íë¨¼íŠ¸ ì°¾ì•„ë³´ë©´ .. í•˜ë‚˜ì˜ ì•½ì† axios.postëŠ” method=='POST'ì™€ ê°™ë‹¤.
//             id, type
//         }); // {'id': 1, 'type': 'like'}ë¡œ ì²˜ë¦¬  data.idë¡œ ì ‘ê·¼ ê°€ëŠ¥ data.type : 'like'
//         likeHandleResponse(data.id, data.type)
//     }

// const likeHandleResponse = (id, type) => {
//         const element = document.querySelector(`.post-id-${id} .post__${type}`); //idì™€ ë²„íŠ¼typeì„ ë°›ì•„ì„œ
//         const originHTML = element.innerHTML;
//         const [buttonType, num] = originHTML.split(', ');  // ['Like', '0'] ìª¼ê°œì„œ ë³€ìˆ˜ì— ì €ì¥
//         const count = Number(num) + 1;//+1í•œ ê°’ì„ countì— ì €ì¥
//         element.innerHTML = `${buttonType} ${count}`;
//     }
// ajaxë¡œ ë‹¤ì‹œì‹œë„
</script>
{% endblock %}